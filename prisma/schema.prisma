generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  L1
  L2
  L3
  SUPERVISOR
  ADMIN
}

enum Shift {
  MORNING
  MID
  NIGHT
  WEEKEND
  ONCALL
}

enum Team {
  SERVICE_DESK
  NETWORK
  SYSTEMS
  SECURITY
  APPLICATION
  FIELD
}

enum TicketStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  WAITING_ON_USER
  WAITING_ON_VENDOR
  ESCALATED
  RESOLVED
  CLOSED
}

enum Priority {
  P1
  P2
  P3
  P4
}

enum Impact {
  LOW
  MEDIUM
  HIGH
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role
  team         Team
  shift        Shift
  active       Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // relations
  requestedTickets Ticket[] @relation("RequesterTickets")
  assignedTickets  Ticket[] @relation("AssigneeTickets")
  escalatedTickets Ticket[] @relation("EscalatedByTickets")
  comments         TicketComment[]
  auditLogs        AuditLog[]
}

model TicketCounter {
  id     Int @id
  nextNo Int
}

model Ticket {
  id            String      @id @default(cuid())
  ticketNo      Int         @unique
  humanId       String      @unique
  subject       String
  description   String
  category      String
  subcategory   String
  impact        Impact
  urgency       Urgency
  priority      Priority
  status        TicketStatus

  requesterId   String
  requester     User        @relation("RequesterTickets", fields: [requesterId], references: [id])

  assignedToId  String?
  assignedTo    User?       @relation("AssigneeTickets", fields: [assignedToId], references: [id])

  requiredLevel Role        // L1/L2/L3 routing intent
  assignedTeam  Team

  escalationReason String?
  escalatedAt      DateTime?
  escalatedById    String?
  escalatedBy      User?     @relation("EscalatedByTickets", fields: [escalatedById], references: [id])

  firstRespondedAt DateTime?
  resolvedAt       DateTime?
  closedAt         DateTime?

  slaFirstResponseDue DateTime?
  slaResolutionDue    DateTime?
  slaPaused           Boolean    @default(false)
  slaPauseReason      String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  comments      TicketComment[]
  auditLogs     AuditLog[]

  @@index([status, priority])
  @@index([assignedToId, status])
  @@index([requesterId, createdAt])
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  ticket     Ticket   @relation(fields: [ticketId], references: [id])
  authorId   String
  author     User     @relation(fields: [authorId], references: [id])
  body       String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([ticketId, createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  ticketId  String?
  ticket    Ticket?  @relation(fields: [ticketId], references: [id])
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  details   Json?
  createdAt DateTime @default(now())

  @@index([ticketId, createdAt])
}
